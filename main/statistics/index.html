<!DOCTYPE html>
<html style="height: 100%">
   <head>
       <meta charset="utf-8">
       <title>智媒体统计报表</title>
       <style type="text/css">
           body{
             overflow: hidden;
           }
       </style>
   </head>
   <body style="height: 100%; margin: 0">

       <div id="container" style="height: 100%"></div>
       <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts-all-3.js"></script>
       <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>
       <script src='../static/libs/socket.io.js'></script>
       <script type="text/javascript">
            var dom = document.getElementById("container");
            var myChart = echarts.init(dom);
            var app = {};
            var option = null;
            var geoCoordMap = {
                "常德市":[111.7087330000,28.9399430000]
            };
            var userData = [
                {name: "常德市", value: 123,key:'asa'},
            ];

            var convertData = function (data) {
                var res = [];
                for (var i = 0; i < data.length; i++) {
                    var geoCoord = geoCoordMap[data[i].name];
                    if (geoCoord) {
                        res.push({
                            name: data[i].name,
                            value: geoCoord.concat(data[i].value)
                        });
                    }
                }
                return res;
            };

            var config = function(userData){
                return  {
                backgroundColor: '#404a59',
                title: {
                    text: '智媒体统计报表',
                    subtext: 'www.zmiti.com',
                    sublink: 'http://www.zmiti.com',
                    x:'center',
                    textStyle: {
                        color: '#fff'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        return params.name + ' : ' + params.value[2];
                    }
                },
                legend: {
                    orient: 'vertical',
                    y: 'bottom',
                    x:'right',
                    data:['智媒体用户分布'],
                    textStyle: {
                        color: '#fff'
                    }
                },
                visualMap: {
                    min: 0,
                    max: 200,
                    calculable: true,
                    inRange: {
                        color: ['#50a3ba', '#eac736', '#d94e5d']
                    },
                    textStyle: {
                        color: '#fff'
                    }
                },
                geo: {
                    map: 'china',
                    roam: true,
                    label: {
                        emphasis: {
                            show: false
                        }
                    },
                    itemStyle: {
                        normal: {
                            areaColor: '#323c48',//地图的背景颜色 
                            borderColor: '#000'//地图边框颜色。
                        },
                        emphasis: {
                            areaColor: '#2a333d'
                        }
                    }
                },
                series: [
                    {
                        name: '智媒体用户分布',
                        type: 'effectScatter',
                        coordinateSystem: 'geo',
                        symbol: '',
                        data:convertData(userData),
                        symbolSize: function(val){
                             return val[2]  / 2 ;
                        },
                        label: {
                            normal: {
                                show: false
                            },
                            emphasis: {
                                show:false
                            }
                        },
                        itemStyle: {
                            emphasis: {
                                borderColor: 'transparent',
                                borderWidth: 3,
                            },
                        }
                    }
                ]
            };
            }

            geoCoordMap = localStorage.getItem('geoCoordMap') || '{}';
            geoCoordMap = JSON.parse(geoCoordMap);
      //      geoCoordMap["常德市"] = [111.7087330000,28.9399430000];

            var userArr = localStorage.getItem('userData')||'{}';
                userData = JSON.parse(userArr).userData || [];
               /* userData.push({
                    name:'常德市',
                    value:25
                })
*/
            myChart.setOption(config(userData), true);
            
            var socket = io('http://socket.zmiti.com:2120');

            /*socket.on('connect', function(){
              socket.emit('login', opt.uid||'');
            });*/
            // 后端推送来消息时
                var s = this;
                socket.on('new_msg', function(msg){
                    msg = msg.replace(/&quot;/g,"\"");

                    var data = JSON.parse(msg);
                    if(data.type !== 'map'){
                        return;
                    }
                    console.log(data);

                    var address = data.address,
                        pos = data.pos;

                    if(geoCoordMap[address]){//存在
                        userData.forEach(function(item,i){
                            if(item.name === address){
                                item.value++;
                            }
                        });
                        
                    }
                    else{
                         geoCoordMap[address] = pos;
                         userData.push({
                            name:address,
                            value:1
                         });   

                    }
                    localStorage.setItem('geoCoordMap',JSON.stringify(geoCoordMap));
                    localStorage.setItem('userData',JSON.stringify({userData:userData}));

                    myChart.setOption(config(userData), true);
                     
                });
            
       </script>

   </body>
</html>